From 4bb717b8718a0770a8b3eb2fa22ee51800ffb884 Mon Sep 17 00:00:00 2001
From: Tilmann Meyer <me@atiltedtree.dev>
Date: Fri, 20 May 2022 22:38:12 +0200
Subject: [PATCH 165/165] musl

---
 dlls/winewayland.drv/opengl.c         |  7 +++----
 dlls/winewayland.drv/wayland.c        | 13 +++++--------
 dlls/winewayland.drv/wayland_remote.c |  7 +++----
 dlls/winewayland.drv/window.c         |  6 ++----
 4 files changed, 13 insertions(+), 20 deletions(-)

diff --git a/dlls/winewayland.drv/opengl.c b/dlls/winewayland.drv/opengl.c
index e7f0b21eebc..9c505cce2a9 100644
--- a/dlls/winewayland.drv/opengl.c
+++ b/dlls/winewayland.drv/opengl.c
@@ -109,10 +109,7 @@ static int nb_pixel_formats, nb_onscreen_formats;
 static BOOL has_khr_create_context;
 static BOOL has_gl_colorspace;
 
-static struct wayland_mutex gl_object_mutex =
-{
-    PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP, 0, 0, __FILE__ ": gl_object_mutex"
-};
+static struct wayland_mutex gl_object_mutex;
 
 static struct wl_list gl_drawables = { &gl_drawables, &gl_drawables };
 static struct wl_list gl_contexts = { &gl_contexts, &gl_contexts };
@@ -1698,6 +1695,8 @@ static BOOL egl_init(void)
     if (retval != -1) return retval;
     retval = 0;
 
+    wayland_mutex_init(&gl_object_mutex, PTHREAD_MUTEX_RECURSIVE, __FILE__ ": gl_object_mutex");
+
     if (!(egl_handle = dlopen(SONAME_LIBEGL, RTLD_NOW|RTLD_GLOBAL)))
     {
         ERR("failed to load %s: %s\n", SONAME_LIBEGL, dlerror());
diff --git a/dlls/winewayland.drv/wayland.c b/dlls/winewayland.drv/wayland.c
index 178e71bfff0..83a896fd550 100644
--- a/dlls/winewayland.drv/wayland.c
+++ b/dlls/winewayland.drv/wayland.c
@@ -37,14 +37,8 @@ WINE_DEFAULT_DEBUG_CHANNEL(waylanddrv);
 
 struct wl_display *process_wl_display = NULL;
 static struct wayland *process_wayland = NULL;
-static struct wayland_mutex process_wayland_mutex =
-{
-    PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP, 0, 0, __FILE__ ": process_wayland_mutex"
-};
-static struct wayland_mutex thread_wayland_mutex =
-{
-    PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP, 0, 0, __FILE__ ": thread_wayland_mutex"
-};
+static struct wayland_mutex process_wayland_mutex;
+static struct wayland_mutex thread_wayland_mutex;
 
 static struct wl_list thread_wayland_list = {&thread_wayland_list, &thread_wayland_list};
 
@@ -409,6 +403,9 @@ void wayland_deinit(struct wayland *wayland)
  */
 BOOL wayland_process_init(void)
 {
+    wayland_mutex_init(&process_wayland_mutex, PTHREAD_MUTEX_RECURSIVE, __FILE__ ": process_wayland_mutex");
+    wayland_mutex_init(&thread_wayland_mutex, PTHREAD_MUTEX_RECURSIVE, __FILE__ ": thread_wayland_mutex");
+
     process_wl_display = wl_display_connect(NULL);
     if (!process_wl_display)
         return FALSE;
diff --git a/dlls/winewayland.drv/wayland_remote.c b/dlls/winewayland.drv/wayland_remote.c
index 44940c672d7..a2d4cb2fd30 100644
--- a/dlls/winewayland.drv/wayland_remote.c
+++ b/dlls/winewayland.drv/wayland_remote.c
@@ -93,10 +93,7 @@ struct wayland_remote_surface_proxy
     enum wayland_remote_surface_type type;
 };
 
-static struct wayland_mutex wayland_remote_surface_mutex =
-{
-    PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP, 0, 0, __FILE__ ": wayland_remote_surface_mutex"
-};
+static struct wayland_mutex wayland_remote_surface_mutex;
 
 static struct wl_list wayland_remote_surfaces = { &wayland_remote_surfaces, &wayland_remote_surfaces };
 static struct wl_list wayland_remote_buffers = { &wayland_remote_buffers, &wayland_remote_buffers};
@@ -147,6 +144,8 @@ static struct wayland_remote_buffer *wayland_remote_buffer_create(struct wayland
         return NULL;
     }
 
+    wayland_mutex_init(&wayland_remote_surface_mutex, PTHREAD_MUTEX_RECURSIVE, __FILE__ ": wayland_remote_surface_mutex");
+
     remote_buffer->hwnd = remote->wayland_surface->hwnd;
     remote_buffer->wl_buffer = wl_buffer;
 
diff --git a/dlls/winewayland.drv/window.c b/dlls/winewayland.drv/window.c
index eb85ea54e1a..662f9129a68 100644
--- a/dlls/winewayland.drv/window.c
+++ b/dlls/winewayland.drv/window.c
@@ -82,10 +82,7 @@ struct wayland_win_data
     BOOL           pending_state_update_message;
 };
 
-static struct wayland_mutex win_data_mutex =
-{
-    PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP, 0, 0, __FILE__ ": win_data_mutex"
-};
+static struct wayland_mutex win_data_mutex;
 
 static struct wayland_win_data *win_data_context[32768];
 
@@ -168,6 +165,7 @@ static struct wayland_win_data *wayland_win_data_create(HWND hwnd)
     data->hwnd = hwnd;
     data->wayland_surface_needs_update = TRUE;
 
+    wayland_mutex_init(&win_data_mutex, PTHREAD_MUTEX_RECURSIVE, __FILE__ ": win_data_mutex");
     wayland_mutex_lock(&win_data_mutex);
     win_data_context[context_idx(hwnd)] = data;
 
-- 
2.35.1

